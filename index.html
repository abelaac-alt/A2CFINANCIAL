<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A2C v8.2</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #000000;
            --bg-card: #111111;
            --bg-nav: rgba(15, 15, 15, 0.98);
            --text-main: #ffffff;
            --text-muted: #888888;
            --inc: #00ff9d; 
            --exp: #ff0055;
            --inv: #f1c40f; 
            --sav: #3498db;
            --radius: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg-body); font-family: 'Inter', sans-serif; color: var(--text-main); padding-bottom: 140px; height: 100vh; overflow-y: auto; }
        
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 20px; }
        .logo { font-weight: 900; font-size: 1.5rem; letter-spacing: -1px; background: linear-gradient(to right, #fff, #777); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* DATE NAV */
        .month-nav {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; background: #1a1a1a; padding: 8px; border-radius: 50px; border: 1px solid #333;
        }
        .nav-arrow { background: none; border: none; color: #fff; font-size: 1.2rem; padding: 0 15px; cursor: pointer; }
        .current-month-label { font-weight: 700; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; }

        /* CARDS */
        .smart-card {
            background: linear-gradient(160deg, #1a1a1a, #0a0a0a); border: 1px solid #222;
            padding: 25px; border-radius: var(--radius); margin-bottom: 20px; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative;
        }
        .main-balance { font-family: 'Fira Code', monospace; font-size: 2.5rem; font-weight: 700; margin: 10px 0; letter-spacing: -1px; }
        .label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }

        /* PORTFOLIO ROW */
        .portfolio-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .port-card { flex: 1; background: #111; border: 1px solid #222; padding: 15px; border-radius: 16px; position: relative; overflow: hidden; }
        .port-label { font-size: 0.65rem; text-transform: uppercase; color: #666; font-weight: 700; margin-bottom: 5px; }
        .port-val { font-family: 'Fira Code'; font-size: 1.1rem; font-weight: 600; }
        .port-icon { position: absolute; right: 10px; bottom: 10px; font-size: 1.5rem; opacity: 0.2; }

        /* WARNING BOX */
        .warning-box {
            background: rgba(255, 0, 85, 0.1); border: 1px solid var(--exp); color: var(--exp);
            padding: 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; 
            text-align: center; margin-bottom: 20px; display: none; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* MONTHLY STATS */
        .safe-spend-box { display: flex; gap: 10px; margin-bottom: 25px; }
        .mini-card { flex: 1; background: var(--bg-card); padding: 15px; border-radius: 15px; border: 1px solid #222; text-align: center; }
        .mini-val { font-family: 'Fira Code'; font-size: 1rem; font-weight: 600; margin-top: 5px; }
        
        /* LIST & ITEMS (Mejorados para texto largo) */
        .search-bar {
            width: 100%; background: #111; border: 1px solid #222; color: #fff; padding: 12px 15px;
            border-radius: 12px; margin-bottom: 20px; font-size: 0.9rem; transition: 0.3s;
        }
        .search-bar:focus { border-color: #444; background: #000; }

        .t-list { 
            display: flex; flex-direction: column; gap: 10px; 
        }

        .t-item {
            background: var(--bg-card); 
            border: 1px solid #1a1a1a; 
            padding: 14px; 
            border-radius: 18px;
            display: flex; 
            align-items: flex-start; /* Alineado arriba para textos largos */
            justify-content: space-between;
            height: auto; /* Altura autom√°tica */
            min-height: 70px;
        }
        
        /* Contenedor Izquierdo (Icono + Textos) */
        .t-left {
            display: flex;
            align-items: flex-start;
            flex: 1; /* Ocupa todo el espacio disponible */
            padding-right: 15px; /* Espacio con el precio */
        }

        .t-icon { 
            width: 42px; height: 42px; 
            border-radius: 12px; background: #1a1a1a; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; margin-right: 15px; 
            flex-shrink: 0; /* Evita que el icono se aplaste */
        }
        
        .t-desc { 
            font-weight: 600; font-size: 0.9rem; color: #eee; 
            margin-bottom: 4px;
            /* Magia para texto completo */
            white-space: normal; 
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .t-meta { font-size: 0.7rem; color: #666; display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .tag { padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size: 0.6rem; text-transform: uppercase; white-space: nowrap; }
        .tag.rec { background: rgba(191,0,255,0.15); color: #d580ff; }
        .tag.inv { background: rgba(241, 196, 15, 0.15); color: var(--inv); }
        
        /* Precio a la derecha */
        .t-amt { 
            font-family: 'Fira Code'; font-weight: 600; 
            white-space: nowrap; /* Precio siempre en una l√≠nea */
            margin-top: 5px; /* Ajuste visual */
        }

        /* FORM */
        .type-switch { display: flex; background: #000; padding: 4px; border-radius: 12px; border: 1px solid #222; margin-bottom: 20px; }
        .type-btn { flex: 1; padding: 12px; border: none; background: transparent; color: #666; font-weight: 600; border-radius: 8px; transition: 0.3s; cursor: pointer; font-size: 0.8rem; }
        .type-btn.active-exp { background: rgba(255, 0, 85, 0.2); color: var(--exp); }
        .type-btn.active-inc { background: rgba(0, 255, 157, 0.2); color: var(--inc); }
        .type-btn.active-inv { background: rgba(241, 196, 15, 0.2); color: var(--inv); }

        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .cat-item {
            background: #111; border: 1px solid #222; border-radius: 12px; padding: 10px;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .cat-item.selected { border-color: var(--text-main); background: #222; }
        .cat-icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
        .cat-name { font-size: 0.6rem; color: #888; text-transform: uppercase; }
        
        input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 12px; font-size: 1rem; margin-bottom: 12px; }

        .btn-action { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: var(--text-main); color: #000; }
        .btn-danger { background: rgba(255,0,85,0.1); color: #ff4444; border: 1px solid #ff4444; margin-top: 15px; }

        /* SETTINGS ROWS */
        .setting-row { background: var(--bg-card); padding: 20px; border-radius: 16px; margin-bottom: 15px; border: 1px solid #222; }
        .setting-title { font-weight: 600; margin-bottom: 5px; }
        .setting-desc { font-size: 0.8rem; color: #666; margin-bottom: 15px; }

        /* VISTAS */
        .view-section { display: none; opacity: 0; transition: opacity 0.2s; }
        .view-section.active { display: block; opacity: 1; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--bg-nav); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border-top: 1px solid #222; padding: 10px 10px 30px; 
            display: grid; grid-template-columns: 1fr 1fr auto 1fr; align-items: center; z-index: 999;
        }
        .nav-btn { background: none; border: none; color: #555; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.65rem; font-weight: 600; cursor: pointer; }
        .nav-btn svg { width: 22px; fill: currentColor; }
        .nav-btn.active { color: #fff; }
        .nav-btn.active svg { fill: #fff; filter: drop-shadow(0 0 5px rgba(255,255,255,0.4)); }

        .add-fab {
            width: 48px; height: 48px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.6rem; color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.2); transform: translateY(-10px); border: none; cursor: pointer; margin: 0 10px;
        }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: flex-end; }
        .modal-overlay.open { display: flex; }
        .modal-sheet { background: #1c1c1c; width: 100%; max-width: 500px; margin: 0 auto; border-radius: 25px 25px 0 0; padding: 25px; border-top: 1px solid #333; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* CALENDAR ALERT BOX */
        .alert-box {
            background: #1c1c1c; padding: 30px; border-radius: 25px; text-align: center; width: 85%; max-width: 320px; border: 1px solid #333; 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .alert-btn { width: 100%; padding: 14px; border-radius: 12px; border:none; font-weight:600; margin-top:10px; cursor:pointer;}
        .btn-cal { background: #4285F4; color:white; }
        .btn-cancel { background: #333; color:#aaa; }

        /* ANALYTICS */
        .segment-bar { display: flex; background: #111; padding: 4px; border-radius: 12px; border: 1px solid #222; margin-bottom: 20px; }
        .seg-btn { flex: 1; background: none; border: none; color: #666; padding: 8px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .seg-btn.active { background: #222; color: #fff; }
        .chart-container { height: 220px; margin: 20px 0; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo">A2C v8.2</div>
        </header>

        <div id="view-home" class="view-section active">
            <div class="month-nav">
                <button class="nav-arrow" onclick="changeMonth(-1)">&#8249;</button>
                <span class="current-month-label" id="month-display">...</span>
                <button class="nav-arrow" onclick="changeMonth(1)">&#8250;</button>
            </div>

            <div class="smart-card">
                <div class="label">Balance Mensual</div>
                <div class="main-balance blur-sens" id="main-balance">0.00‚Ç¨</div>
            </div>

            <div id="warning-msg" class="warning-box"></div>

            <div class="portfolio-row">
                <div class="port-card">
                    <div class="port-label" style="color:var(--sav)">Ahorro Total</div>
                    <div class="port-val blur-sens" id="total-savings" style="color:var(--sav)">0‚Ç¨</div>
                    <div class="port-icon">üê∑</div>
                </div>
                <div class="port-card">
                    <div class="port-label" style="color:var(--inv)">Inversiones</div>
                    <div class="port-val blur-sens" id="total-invest" style="color:var(--inv)">0‚Ç¨</div>
                    <div class="port-icon">üìà</div>
                </div>
            </div>

            <div class="safe-spend-box">
                <div class="mini-card">
                    <div class="label" style="color:var(--inc)">Ingresos (Mes)</div>
                    <div class="mini-val blur-sens" id="val-inc" style="color:var(--inc)">+0‚Ç¨</div>
                </div>
                <div class="mini-card">
                    <div class="label" style="color:var(--exp)">Gastos (Mes)</div>
                    <div class="mini-val blur-sens" id="val-exp" style="color:var(--exp)">-0‚Ç¨</div>
                </div>
            </div>

            <input type="text" class="search-bar" id="search-input" placeholder="üîç Buscar movimiento..." onkeyup="renderList()">
            
            <div class="label" style="margin-bottom:15px">Movimientos del Mes</div>
            <div id="transactions-list" class="t-list"></div>
        </div>

        <div id="view-analytics" class="view-section">
            <div class="label" style="margin-bottom:15px; font-size:1rem;">Anal√≠ticas</div>
            <div class="segment-bar">
                <button class="seg-btn" id="seg-day" onclick="setAnalyticsSegment('day')">D√≠a</button>
                <button class="seg-btn" id="seg-week" onclick="setAnalyticsSegment('week')">Sem</button>
                <button class="seg-btn active" id="seg-month" onclick="setAnalyticsSegment('month')">Mes</button>
                <button class="seg-btn" id="seg-year" onclick="setAnalyticsSegment('year')">A√±o</button>
            </div>
            <div class="mini-card" style="margin-bottom:20px">
                <div class="chart-container"><canvas id="catChart"></canvas></div>
            </div>
            <div class="mini-card">
                <div class="chart-container"><canvas id="trendChart"></canvas></div>
            </div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="label" style="margin-bottom:15px; font-size:1rem;">Ajustes</div>
            
            <div class="setting-row">
                <div class="setting-title">Copia de Seguridad</div>
                <div class="setting-desc">Guarda tus datos en un archivo para no perderlos, o carga una copia anterior.</div>
                <div style="display:flex; gap:10px; margin-top:15px">
                    <button class="btn-action btn-primary" onclick="exportData()">‚¨áÔ∏è Guardar Copia</button>
                    <button class="btn-action" style="background:#333; color:#fff" onclick="document.getElementById('import-file').click()">‚¨ÜÔ∏è Subir Backup</button>
                    <input type="file" id="import-file" style="display:none" onchange="importData(this)">
                </div>
            </div>

            <div class="setting-row" style="margin-top:20px; border-color:#222; opacity:0.6">
                 <div class="setting-title" style="color:#666; font-size:0.8rem">ZONA T√âCNICA</div>
                 <div class="setting-desc">A2C FINANCIAL v8.2</div>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" id="nav-home" onclick="switchView('home')">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Inicio</span>
        </button>
        <button class="nav-btn" id="nav-analytics" onclick="switchView('analytics')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
            <span>Data</span>
        </button>
        <button class="add-fab" onclick="openForm()">+</button>
        <button class="nav-btn" id="nav-settings" onclick="switchView('settings')">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            <span>Ajustes</span>
        </button>
    </nav>

    <div class="modal-overlay" id="form-modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-sheet">
            <div id="form-title" style="text-align:center; margin-bottom:20px; color:#555; font-weight:700">TRANSACCI√ìN</div>
            
            <div class="type-switch">
                <button id="btn-type-exp" class="type-btn active-exp" onclick="setType('expense')">Gasto</button>
                <button id="btn-type-inc" class="type-btn" onclick="setType('income')">Ingreso</button>
                <button id="btn-type-inv" class="type-btn" onclick="setType('investment')">Inversi√≥n</button>
            </div>

            <input type="text" id="inp-desc" placeholder="Concepto (ej. SP500, N√≥mina)" required>
            <div style="display:flex; gap:10px">
                <input type="number" id="inp-amt" placeholder="0.00" step="0.01" style="flex:1" required>
                <input type="date" id="inp-date" style="flex:1" required>
            </div>
            
            <div class="label" style="margin:10px 0 5px">Categor√≠a</div>
            <div class="cat-grid" id="cat-grid"></div>

            <div style="display:flex; align-items:center; gap:10px; margin:20px 0; background:#111; padding:10px; border-radius:12px;">
                <input type="checkbox" id="inp-rec" style="width:20px; height:20px; margin:0; accent-color:var(--neon-rec)">
                <label for="inp-rec" style="font-size:0.9rem; color:#aaa">Fijo / Recurrente</label>
            </div>

            <button class="btn-action btn-primary" onclick="saveTransaction()">GUARDAR</button>
            <button id="btn-delete-tr" class="btn-action btn-danger" style="display:none" onclick="deleteTr()">ELIMINAR</button>
        </div>
    </div>

    <div class="modal-overlay" id="cal-overlay">
        <div class="alert-box">
            <div style="font-size:3rem; margin-bottom:15px;">üìÖ</div>
            <h3 style="margin-bottom:10px; color:#fff;">Programar</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;" id="cal-text">...</p>
            <button class="alert-btn btn-cal" id="btn-go-cal">A√±adir a Google Calendar</button>
            <button class="alert-btn btn-cancel" onclick="document.getElementById('cal-overlay').classList.remove('open')">Cancelar</button>
        </div>
    </div>

    <script>
        // CONFIG & STATE
        Chart.defaults.color = '#666'; Chart.defaults.borderColor = '#222';
        const CATS = [
            {id:'food', n:'Comida', i:'üçî'}, {id:'home', n:'Casa', i:'üè†'}, {id:'trans', n:'Transp.', i:'üöó'}, 
            {id:'fun', n:'Ocio', i:'üéâ'}, {id:'shop', n:'Compras', i:'üõçÔ∏è'}, {id:'health', n:'Salud', i:'üíä'}, 
            {id:'bills', n:'Facturas', i:'üìÑ'}, {id:'inc', n:'Ingreso', i:'üí∞'},
            {id:'invest', n:'Inversi√≥n', i:'üìà'}
        ];
        
        let db = JSON.parse(localStorage.getItem('a2c_ultimate')) || [];
        let editingId = null;
        let selectedCat = 'food';
        let currentType = 'expense';
        let charts = {};
        let tempCalData = null; // Para el calendario
        
        let currentViewDate = new Date(); 
        let analyticsSegment = 'month';

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            renderCats();
            updateUI();
        });

        // --- NAVIGATION ---
        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nav-' + v)) document.getElementById('nav-' + v).classList.add('active');
            
            if(v === 'analytics') setTimeout(runAnalytics, 100);
        }

        function changeMonth(delta) {
            currentViewDate.setMonth(currentViewDate.getMonth() + delta);
            updateUI();
        }

        // --- CORE UI ---
        function updateUI() {
            db.sort((a,b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('a2c_ultimate', JSON.stringify(db));

            // Header Date
            document.getElementById('month-display').innerText = currentViewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            // 1. CALCULATE GLOBALS
            let globalLiquid = 0; 
            let globalInvested = 0; 

            db.forEach(t => {
                if(t.cat === 'invest') {
                    globalLiquid += t.amt; // resta
                    globalInvested += Math.abs(t.amt); // suma
                } else {
                    globalLiquid += t.amt;
                }
            });

            document.getElementById('total-savings').innerText = fmt(globalLiquid);
            document.getElementById('total-invest').innerText = fmt(globalInvested);

            // 2. MONTHLY STATS
            const visibleData = getMonthlyData(currentViewDate);
            
            const mIncome = visibleData.filter(t=>t.amt>0).reduce((a,b)=>a+b.amt,0);
            const mExpense = visibleData.filter(t=>t.amt<0 && t.cat!=='invest').reduce((a,b)=>a+b.amt,0);
            const mInvest = visibleData.filter(t=>t.cat==='invest').reduce((a,b)=>a+b.amt,0);
            
            const monthBalance = mIncome + mExpense + mInvest;

            document.getElementById('main-balance').innerText = fmt(monthBalance);
            document.getElementById('val-inc').innerText = '+' + fmt(mIncome);
            document.getElementById('val-exp').innerText = fmt(mExpense);

            // 3. ALERT SYSTEM
            const warnBox = document.getElementById('warning-msg');
            if ((mIncome + mExpense) < 0) {
                const deficit = Math.abs(mIncome + mExpense);
                warnBox.style.display = 'block';
                warnBox.innerText = `‚ö†Ô∏è CUIDADO: Usando Ahorros (-${deficit.toFixed(0)}‚Ç¨)`;
            } else {
                warnBox.style.display = 'none';
            }

            renderList(visibleData);
        }

        function getMonthlyData(targetDate) {
            const tM = targetDate.getMonth();
            const tY = targetDate.getFullYear();
            
            const real = db.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === tM && d.getFullYear() === tY;
            });

            const projected = [];
            db.forEach(t => {
                if(t.rec) {
                    const d = new Date(t.date);
                    if(d < new Date(tY, tM, 1)) {
                        projected.push({
                            ...t,
                            date: new Date(tY, tM, d.getDate()).toISOString().split('T')[0],
                            id: 'proj_' + t.id, 
                            isProj: true
                        });
                    }
                }
            });

            return [...real, ...projected].sort((a,b)=>new Date(b.date)-new Date(a.date));
        }

        function renderList(list) {
            const el = document.getElementById('transactions-list'); el.innerHTML = '';
            const q = document.getElementById('search-input').value.toLowerCase();
            
            list.filter(t => t.desc.toLowerCase().includes(q)).forEach(t => {
                const c = CATS.find(x=>x.id===t.cat) || CATS[0];
                
                let color = t.amt < 0 ? '#fff' : 'var(--inc)';
                if(t.cat === 'invest') color = 'var(--inv)';

                const tag = t.isProj ? '<span class="tag" style="background:#333;color:#aaa">PROYECTADO</span>' : (t.rec ? '<span class="tag rec">FIJO</span>' : '');
                const clickFn = `editTr('${t.id}')`;

                el.innerHTML += `
                <div class="t-item" onclick="${clickFn}" style="${t.isProj ? 'opacity:0.6; border:1px dashed #333':''}">
                    <div class="t-left">
                        <div class="t-icon">${c.i}</div>
                        <div>
                            <div class="t-desc">${t.desc}</div>
                            <div class="t-meta">
                                ${new Date(t.date).toLocaleDateString('es-ES', {day:'numeric', month:'short'})}
                                ${tag}
                            </div>
                        </div>
                    </div>
                    <div class="t-amt" style="color:${color}">${t.amt>0?'+':''}${t.amt.toFixed(2)}‚Ç¨</div>
                </div>`;
            });
        }

        function renderCats() {
            const g = document.getElementById('cat-grid'); g.innerHTML = '';
            CATS.forEach(c => {
                g.innerHTML += `<div class="cat-item ${c.id===selectedCat?'selected':''}" onclick="selCat('${c.id}')">
                    <span class="cat-icon">${c.i}</span><span class="cat-name">${c.n}</span>
                </div>`;
            });
        }

        // --- ADD / EDIT / DELETE ---
        function openForm() { 
            document.getElementById('form-modal').classList.add('open'); 
            document.getElementById('form-title').innerText = "NUEVA TRANSACCI√ìN";
            if(!editingId){ 
                document.getElementById('inp-date').valueAsDate = new Date(); 
                document.getElementById('inp-amt').value=''; 
                document.getElementById('inp-desc').value=''; 
                document.getElementById('btn-delete-tr').style.display = 'none'; 
                setType('expense'); 
                selCat('food'); 
            } 
        }
        function closeModal() { document.getElementById('form-modal').classList.remove('open'); editingId = null; }

        function setType(type) {
            currentType = type;
            document.getElementById('btn-type-exp').className = type==='expense' ? 'type-btn active-exp' : 'type-btn';
            document.getElementById('btn-type-inc').className = type==='income' ? 'type-btn active-inc' : 'type-btn';
            document.getElementById('btn-type-inv').className = type==='investment' ? 'type-btn active-inv' : 'type-btn';
            if(type === 'investment') selCat('invest');
            else if(selectedCat === 'invest') selCat('food'); 
        }
        function selCat(id) { selectedCat = id; renderCats(); }

        function saveTransaction() {
            const desc = document.getElementById('inp-desc').value;
            let rawAmt = parseFloat(document.getElementById('inp-amt').value);
            const date = document.getElementById('inp-date').value;
            const rec = document.getElementById('inp-rec').checked;
            
            if(!desc || !rawAmt || !date) return;
            
            let amt = 0;
            if(currentType === 'expense') amt = -Math.abs(rawAmt);
            else if(currentType === 'investment') amt = -Math.abs(rawAmt); 
            else amt = Math.abs(rawAmt); 

            if(editingId) {
                const cleanId = String(editingId).replace('proj_', '');
                const idx = db.findIndex(t=>String(t.id) === cleanId);
                if(idx > -1) {
                    db[idx] = {id:db[idx].id, desc, amt, date, cat:selectedCat, rec}; 
                }
            } else {
                const newTr = {id:Date.now(), desc, amt, date, cat:selectedCat, rec};
                db.push(newTr);
                if(rec) askCalendar(newTr);
            }
            closeModal(); updateUI();
        }

        function editTr(id) {
            const isProj = String(id).startsWith('proj_');
            const cleanId = String(id).replace('proj_', '');
            const t = db.find(x => String(x.id) === cleanId); 
            
            if(!t) return;

            editingId = id;
            document.getElementById('form-title').innerText = isProj ? "EDITAR REGLA ORIGINAL" : "EDITAR TRANSACCI√ìN";
            document.getElementById('inp-desc').value = t.desc;
            document.getElementById('inp-amt').value = Math.abs(t.amt);
            document.getElementById('inp-date').value = t.date; 
            document.getElementById('inp-rec').checked = t.rec;
            
            if(t.cat === 'invest') setType('investment');
            else setType(t.amt < 0 ? 'expense' : 'income');
            
            selCat(t.cat);
            
            document.getElementById('btn-delete-tr').style.display = 'block'; 
            document.getElementById('btn-delete-tr').innerText = isProj ? "ELIMINAR REGLA (Y FUTUROS)" : "ELIMINAR";
            
            document.getElementById('form-modal').classList.add('open');
        }

        function deleteTr() {
            const cleanId = String(editingId).replace('proj_', '');
            if(confirm("¬øSeguro que quieres eliminarlo?")) {
                db = db.filter(t => String(t.id) !== cleanId);
                closeModal(); updateUI();
            }
        }

        // --- CALENDAR LOGIC ---
        function askCalendar(d){ 
            tempCalData=d; 
            const typeText = d.amt < 0 ? "Gasto" : "Ingreso";
            document.getElementById('cal-text').innerText=`¬øAgendar "${d.desc}" en Google Calendar?`; 
            document.getElementById('cal-overlay').classList.add('open'); 
        }

        document.getElementById('btn-go-cal').addEventListener('click', ()=>{
            if(!tempCalData)return;
            const d=new Date(tempCalData.date).toISOString().replace(/-|:|\.\d+/g,"").slice(0,8);
            const verb = tempCalData.amt < 0 ? "Pagar" : "Cobrar";
            const t=encodeURIComponent(`${verb} ${tempCalData.desc} (${Math.abs(tempCalData.amt)}‚Ç¨)`);
            window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${t}&dates=${d}/${d}&recur=RRULE:FREQ=MONTHLY`,'_blank');
            document.getElementById('cal-overlay').classList.remove('open');
        });

        // --- BACKUP ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "backup_a2c.json");
            document.body.appendChild(node); node.click(); node.remove();
        }
        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    db = JSON.parse(e.target.result);
                    updateUI(); alert('Datos restaurados con √©xito');
                } catch(err) { alert('Error al leer el archivo'); }
            };
            reader.readAsText(file);
        }

        // --- ANALYTICS ---
        function setAnalyticsSegment(seg) {
            analyticsSegment = seg;
            document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('seg-'+seg).classList.add('active');
            runAnalytics();
        }

        function runAnalytics() {
            const now = new Date();
            let start, end;
            if(analyticsSegment === 'day') {
                start = new Date(); start.setHours(0,0,0,0);
                end = new Date(); end.setHours(23,59,59,999);
            } else if (analyticsSegment === 'week') {
                const day = now.getDay() || 7; 
                if(day !== 1) now.setHours(-24 * (day - 1)); 
                start = new Date(now); start.setHours(0,0,0,0);
                end = new Date(start); end.setDate(start.getDate()+6);
            } else if (analyticsSegment === 'month') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth()+1, 0);
            } else { 
                start = new Date(now.getFullYear(), 0, 1);
                end = new Date(now.getFullYear(), 11, 31);
            }

            const flt = db.filter(t => {
                const d = new Date(t.date);
                return d >= start && d <= end;
            });

            const catAmts = {};
            flt.filter(t=>t.amt<0).forEach(t => { catAmts[t.cat] = (catAmts[t.cat] || 0) + Math.abs(t.amt); });
            
            if(charts.c1) charts.c1.destroy();
            charts.c1 = new Chart(document.getElementById('catChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catAmts).map(k=>CATS.find(x=>x.id===k)?.n || k),
                    datasets: [{
                        data: Object.values(catAmts),
                        backgroundColor: ['#2d9cdb','#bf00ff','#ff0055','#ffcc00','#00ff9d','#fff','#f1c40f','#888'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{color:'#fff'}}} }
            });

            const days = {};
            flt.filter(t=>t.amt<0).forEach(t => { 
                let k = new Date(t.date).getDate();
                if(analyticsSegment==='year') k = new Date(t.date).getMonth()+1;
                days[k] = (days[k]||0) + Math.abs(t.amt); 
            });
            const lbls = Object.keys(days).sort((a,b)=>a-b);
            
            if(charts.c2) charts.c2.destroy();
            charts.c2 = new Chart(document.getElementById('trendChart'), {
                type: 'bar',
                data: { labels: lbls, datasets: [{ label:'Gasto', data:lbls.map(l=>days[l]), backgroundColor:'#333', borderRadius:4 }] },
                options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{display:false}} }
            });
        }
        
        const fmt = (n) => n.toLocaleString('es-ES', {style:'currency', currency:'EUR'});
    </script>
</body>
</html>
