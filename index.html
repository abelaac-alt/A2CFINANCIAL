<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A2C v12.0 Master</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #050505;
            --bg-surface: #121212;
            --bg-card: #1E1E1E;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --text-main: #FFFFFF;
            --text-sec: #A0A0A0;
            --inc: #4ADE80; 
            --exp: #F87171; 
            --inv: #FACC15; 
            --sav: #38BDF8; 
            --radius-lg: 28px;
            --radius-sm: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg-body); font-family: 'Manrope', sans-serif; color: var(--text-main); padding-bottom: 140px; min-height: 100vh; overflow-y: auto; -webkit-font-smoothing: antialiased; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px 20px 40px; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 30px; }
        .logo { font-weight: 800; font-size: 1.5rem; letter-spacing: -0.02em; background: linear-gradient(90deg, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .month-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; background: rgba(30, 30, 30, 0.5); padding: 8px 12px; border-radius: 100px; border: 1px solid var(--border-subtle); backdrop-filter: blur(12px); width: fit-content; margin-left: auto; margin-right: auto; }
        .nav-arrow { background: none; border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .nav-arrow:active { background: rgba(255,255,255,0.1); }
        .current-month-label { font-weight: 700; font-size: 0.85rem; letter-spacing: 0.5px; padding: 0 15px; text-transform: uppercase; }

        /* CARDS - CLICKABLE */
        .smart-card, .port-card, .stat-pill { cursor: pointer; transition: transform 0.2s, background 0.2s; }
        .smart-card:active, .port-card:active, .stat-pill:active { transform: scale(0.97); }

        .smart-card { background: linear-gradient(180deg, var(--bg-card) 0%, #161616 100%); border: 1px solid var(--border-subtle); padding: 35px 25px; border-radius: var(--radius-lg); margin-bottom: 25px; text-align: center; position: relative; overflow: hidden; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5); }
        .main-balance { font-family: 'JetBrains Mono', monospace; font-size: 3rem; font-weight: 500; margin: 10px 0; letter-spacing: -2px; }
        .label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-sec); font-weight: 600; letter-spacing: 1px; }

        .portfolio-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .port-card { background: var(--bg-surface); border: 1px solid var(--border-subtle); padding: 20px; border-radius: var(--radius-sm); position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 100px; }
        .port-label { font-size: 0.7rem; color: var(--text-sec); font-weight: 600; text-transform: uppercase; }
        .port-val { font-family: 'JetBrains Mono'; font-size: 1.2rem; font-weight: 600; letter-spacing: -0.5px; }
        .port-icon { position: absolute; right: 15px; top: 15px; font-size: 1.2rem; opacity: 0.8; }

        .month-stats { display: flex; gap: 15px; margin-bottom: 35px; }
        .stat-pill { flex: 1; background: rgba(255,255,255,0.03); padding: 12px 15px; border-radius: 12px; border: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
        .stat-val { font-family: 'JetBrains Mono'; font-size: 0.95rem; font-weight: 600; }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; display: inline-block; }

        /* LIST */
        .date-header { font-size: 0.8rem; font-weight: 700; color: var(--text-sec); margin: 20px 0 10px 5px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 5; }
        .t-group { margin-bottom: 10px; border-radius: 20px; overflow: hidden; border: 1px solid var(--border-subtle); }
        .t-item { background: var(--bg-surface); border-bottom: 1px solid rgba(255,255,255,0.03); padding: 16px; display: flex; align-items: flex-start; justify-content: space-between; transition: background 0.2s; cursor: pointer; }
        .t-item:last-child { border-bottom: none; }
        .t-left { display: flex; align-items: flex-start; flex: 1; padding-right: 15px; }
        .t-icon { width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; flex-shrink: 0; }
        .t-desc { font-weight: 600; font-size: 0.95rem; color: #fff; margin-bottom: 4px; line-height: 1.3; }
        .t-meta { font-size: 0.75rem; color: var(--text-sec); display: flex; gap: 8px; align-items: center; }
        .tag { padding: 2px 4px; border-radius: 4px; font-weight: 800; font-size: 0.55rem; text-transform: uppercase; }
        .tag.rec { background: rgba(56, 189, 248, 0.15); color: var(--sav); }
        .tag.proj { border: 1px dashed #666; color: #888; }
        .t-amt { font-family: 'JetBrains Mono'; font-weight: 600; font-size: 1rem; margin-top: 2px; }

        /* FILTER INDICATOR */
        #filter-info { display: none; background: #fff; color: #000; padding: 10px 15px; border-radius: 12px; margin-bottom: 20px; font-size: 0.8rem; font-weight: 700; justify-content: space-between; align-items: center; animation: fadeIn 0.3s; }

        /* UI */
        input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 18px; border-radius: 16px; font-size: 1.1rem; margin-bottom: 15px; font-family: 'JetBrains Mono'; outline: none; }
        .type-switch { display: flex; background: #000; padding: 4px; border-radius: 16px; border: 1px solid #333; margin-bottom: 25px; }
        .type-btn { flex: 1; padding: 14px; border: none; background: transparent; color: #666; font-weight: 700; border-radius: 12px; cursor: pointer; }
        .type-btn.active-exp { background: rgba(248, 113, 113, 0.15); color: var(--exp); }
        .type-btn.active-inc { background: rgba(74, 222, 128, 0.15); color: var(--inc); }
        .type-btn.active-inv { background: rgba(250, 204, 21, 0.15); color: var(--inv); }
        .btn-action { width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-primary { background: #fff; color: #000; }
        .btn-danger { background: rgba(248, 113, 113, 0.1); color: var(--exp); margin-top: 15px; }
        .search-bar { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); color: #fff; padding: 14px 20px; border-radius: 16px; margin-bottom: 25px; font-size: 0.95rem; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 420px; background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); border-radius: 100px; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 999; box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        .nav-btn { background: none; border: none; color: rgba(255, 255, 255, 0.4); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.65rem; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .nav-btn.active { color: #FFFFFF; }
        .add-fab { width: 56px; height: 56px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.25); transform: translateY(-20px); border: none; cursor: pointer; }

        .view-section { display: none; opacity: 0; }
        .view-section.active { display: block; animation: fadeIn 0.4s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: flex-end; }
        .modal-overlay.open { display: flex; }
        .modal-sheet { background: #111; width: 100%; max-width: 500px; margin: 0 auto; border-radius: 30px 30px 0 0; padding: 30px 25px; border-top: 1px solid #333; animation: slideUp 0.3s forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* ANALYTICS */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: #111; border: 1px solid #222; padding: 15px 10px; border-radius: 16px; text-align: center; }
        .kpi-val { font-family: 'JetBrains Mono'; font-size: 0.9rem; font-weight: 700; margin-top: 5px; }
        .kpi-title { font-size: 0.6rem; color: #666; text-transform: uppercase; font-weight: 700; }
        .chart-box { background: #111; border: 1px solid #222; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .chart-container { height: 220px; }
        .seg-btn { flex: 1; background: none; border: none; color: #666; padding: 10px; border-radius: 100px; font-size: 0.8rem; font-weight: 700; cursor: pointer; }
        .seg-btn.active { background: #222; color: #fff; }
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .cat-item { background: #181818; border: 1px solid #222; border-radius: 16px; padding: 15px 10px; text-align: center; cursor: pointer; }
        .cat-item.selected { border-color: #fff; background: #222; }
    </style>
</head>
<body>

    <div class="container">
        <header><div class="logo">A2C v12.0</div></header>

        <div id="view-home" class="view-section active">
            <div class="month-nav">
                <button class="nav-arrow" onclick="changeMonth(-1)">&#8249;</button>
                <span class="current-month-label" id="month-display">...</span>
                <button class="nav-arrow" onclick="changeMonth(1)">&#8250;</button>
            </div>

            <div class="smart-card" onclick="setListFilter('all_month', 'Balance Mensual')">
                <div class="label">Balance Mensual</div>
                <div class="main-balance blur-sens" id="main-balance">0.00</div>
            </div>

            <div class="portfolio-row">
                <div class="port-card" onclick="setListFilter('wealth', 'Patrimonio Neto')">
                    <div class="port-label">Patrimonio Neto</div>
                    <div class="port-val blur-sens" id="total-savings" style="color:var(--sav)">0‚Ç¨</div>
                    <div class="port-icon">üèõÔ∏è</div>
                </div>
                <div class="port-card" onclick="setListFilter('invest', 'Inversiones Totales')">
                    <div class="port-label">Inversiones</div>
                    <div class="port-val blur-sens" id="total-invest" style="color:var(--inv)">0‚Ç¨</div>
                    <div class="port-icon">üìà</div>
                </div>
            </div>

            <div class="month-stats">
                <div class="stat-pill" onclick="setListFilter('income', 'Ingresos del Mes')">
                    <span style="font-size:0.7rem; color:#888"><span class="dot" style="background:var(--inc)"></span>INGRESOS</span>
                    <span class="stat-val blur-sens" id="val-inc" style="color:var(--inc)">0</span>
                </div>
                <div class="stat-pill" onclick="setListFilter('expense', 'Gastos del Mes')">
                    <span style="font-size:0.7rem; color:#888"><span class="dot" style="background:var(--exp)"></span>GASTOS</span>
                    <span class="stat-val blur-sens" id="val-exp" style="color:var(--text-main)">0</span>
                </div>
            </div>

            <div id="filter-info">
                <span id="filter-text">Viendo: Todo</span>
                <button onclick="setListFilter(null)" style="background:none; border:none; font-weight:900; cursor:pointer">‚úï</button>
            </div>

            <input type="text" class="search-bar" id="search-input" placeholder="üîç Buscar transacci√≥n..." onkeyup="renderList()">
            <div id="transactions-list" class="t-list"></div>
        </div>

        <div id="view-analytics" class="view-section">
            <div class="label" style="margin-bottom:15px; font-size:1rem;">Anal√≠ticas Avanzadas</div>
            <div class="month-stats" style="background:#111; padding:5px; border-radius:100px; border:1px solid #222">
                <button class="seg-btn" id="seg-day" onclick="setAnalSegment('day')">D√≠a</button>
                <button class="seg-btn" id="seg-week" onclick="setAnalSegment('week')">Sem</button>
                <button class="seg-btn active" id="seg-month" onclick="setAnalSegment('month')">Mes</button>
                <button class="seg-btn" id="seg-year" onclick="setAnalSegment('year')">A√±o</button>
            </div>
            <div class="kpi-row" style="margin-top:20px">
                <div class="kpi-card"><div class="kpi-title">Ahorro</div><div class="kpi-val" id="kpi-rate" style="color:var(--inc)">0%</div></div>
                <div class="kpi-card"><div class="kpi-title">Cash Flow</div><div class="kpi-val" id="kpi-flow">0‚Ç¨</div></div>
                <div class="kpi-card"><div class="kpi-title">Promedio</div><div class="kpi-val" id="kpi-avg">0‚Ç¨</div></div>
            </div>
            <div class="chart-box"><div class="chart-container"><canvas id="flowChart"></canvas></div></div>
            <div class="chart-box"><div class="chart-container"><canvas id="catChart"></canvas></div></div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="label" style="margin-bottom:15px; font-size:1rem;">Ajustes</div>
            <div style="background:#111; padding:25px; border-radius:20px; border:1px solid #222">
                <button class="btn-action btn-primary" onclick="exportData()">‚¨áÔ∏è Exportar Backup</button>
                <button class="btn-action" style="margin-top:10px; background:#222; color:#fff" onclick="document.getElementById('import-file').click()">‚¨ÜÔ∏è Importar Backup</button>
                <input type="file" id="import-file" style="display:none" onchange="importData(this)">
            </div>
        </div>
    </nav>

    <nav class="bottom-nav" id="main-nav">
        <button class="nav-btn active" id="nav-home" onclick="switchView('home')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Inicio</span></button>
        <button class="nav-btn" id="nav-analytics" onclick="switchView('analytics')"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>Data</span></button>
        <button class="add-fab" onclick="openForm()">+</button>
        <button class="nav-btn" id="nav-settings" onclick="switchView('settings')"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg><span>Ajustes</span></button>
    </nav>

    <div class="modal-overlay" id="form-modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-sheet">
            <div id="form-title" style="text-align:center; margin-bottom:20px; font-weight:800; color:#888">TRANSACCI√ìN</div>
            <div class="type-switch">
                <button id="btn-type-exp" class="type-btn active-exp" onclick="setType('expense')">Gasto</button>
                <button id="btn-type-inc" class="type-btn" onclick="setType('income')">Ingreso</button>
                <button id="btn-type-inv" class="type-btn" onclick="setType('investment')">Inversi√≥n</button>
            </div>
            <input type="text" id="inp-desc" placeholder="Concepto (ej. Nomina, Visa)">
            <div style="display:flex; gap:10px">
                <input type="number" id="inp-amt" placeholder="0.00" style="flex:1">
                <input type="date" id="inp-date" style="flex:1">
            </div>
            <div class="cat-grid" id="cat-grid"></div>
            <div style="background:#181818; padding:15px; border-radius:12px; border:1px solid #333; margin:20px 0; display:flex; align-items:center; gap:10px">
                <input type="checkbox" id="inp-rec" style="width:20px; height:20px; margin:0">
                <label style="font-size:0.9rem; color:#aaa">Gasto Fijo / Recurrente</label>
            </div>
            <button class="btn-action btn-primary" onclick="saveTransaction()">GUARDAR</button>
            <button id="btn-delete-tr" class="btn-action btn-danger" style="display:none" onclick="deleteTr()">ELIMINAR</button>
        </div>
    </div>

    <script>
        const CATS = [{id:'food', n:'Comida', i:'üçî'},{id:'home', n:'Casa', i:'üè†'},{id:'trans', n:'Transp.', i:'üöó'},{id:'fun', n:'Ocio', i:'üéâ'},{id:'shop', n:'Compras', i:'üõçÔ∏è'},{id:'health', n:'Salud', i:'üíä'},{id:'bills', n:'Facturas', i:'üìÑ'},{id:'inc', n:'Ingreso', i:'üí∞'},{id:'invest', n:'Inversi√≥n', i:'üìà'}];
        let db = JSON.parse(localStorage.getItem('a2c_ultimate')) || [];
        let currentViewDate = new Date();
        let selectedCat = 'food', currentType = 'expense', editingId = null;
        let analSegment = 'month', charts = {}, activeFilter = null;

        document.addEventListener('DOMContentLoaded', () => { renderCats(); updateUI(); });

        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + v).classList.add('active');
            if(v === 'analytics') setTimeout(runAnalytics, 100);
        }

        function changeMonth(d) { currentViewDate.setMonth(currentViewDate.getMonth() + d); updateUI(); }

        // --- FILTER ENGINE ---
        function setListFilter(type, label) {
            activeFilter = type;
            const info = document.getElementById('filter-info');
            if(type) {
                info.style.display = 'flex';
                document.getElementById('filter-text').innerText = 'Viendo: ' + label;
            } else {
                info.style.display = 'none';
            }
            updateUI();
        }

        function updateUI() {
            db.sort((a,b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('a2c_ultimate', JSON.stringify(db));
            document.getElementById('month-display').innerText = currentViewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            // Universal Data Engine
            const start = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth(), 1);
            const end = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth() + 1, 0);
            const monthData = getDataInRange(start, end);

            // Totals
            let tLiq = 0, tInv = 0;
            db.forEach(t => { if(t.cat==='invest'){ tLiq+=t.amt; tInv+=Math.abs(t.amt); } else { tLiq+=t.amt; } });
            document.getElementById('total-savings').innerText = fmt(tLiq);
            document.getElementById('total-invest').innerText = fmt(tInv);

            const mInc = monthData.filter(t=>t.amt>0).reduce((a,b)=>a+b.amt,0);
            const mExp = monthData.filter(t=>t.amt<0 && t.cat!=='invest').reduce((a,b)=>a+Math.abs(t.amt),0);
            const mInv = monthData.filter(t=>t.cat==='invest').reduce((a,b)=>a+Math.abs(t.amt),0);
            
            document.getElementById('main-balance').innerText = fmt(mInc - mExp - mInv);
            document.getElementById('val-inc').innerText = '+' + fmt(mInc);
            document.getElementById('val-exp').innerText = fmt(mExp);

            // Rendering with Active Filter
            let displayList = monthData;
            if(activeFilter === 'income') displayList = monthData.filter(t=>t.amt>0);
            if(activeFilter === 'expense') displayList = monthData.filter(t=>t.amt<0 && t.cat!=='invest');
            if(activeFilter === 'invest') displayList = db.filter(t=>t.cat==='invest'); // Inversiones son globales
            if(activeFilter === 'wealth') displayList = db; // Patrimonio es global
            
            renderList(displayList);
        }

        function getDataInRange(s, e) {
            const rangeStart = new Date(s).setHours(0,0,0,0);
            const rangeEnd = new Date(e).setHours(23,59,59,999);
            const res = [];
            db.forEach(t => {
                const d = new Date(t.date); d.setHours(0,0,0,0);
                if(!t.rec) { if(d.getTime() >= rangeStart && d.getTime() <= rangeEnd) res.push(t); }
                else {
                    let ptr = new Date(d);
                    while(ptr.getTime() <= rangeEnd) {
                        if(ptr.getTime() >= rangeStart) res.push({...t, date: ptr.toISOString().split('T')[0], id: t.id+'_'+ptr.getTime(), isProj: true});
                        ptr.setMonth(ptr.getMonth() + 1);
                    }
                }
            });
            return res.sort((a,b) => new Date(b.date) - new Date(a.date));
        }

        function renderList(list) {
            const el = document.getElementById('transactions-list'); el.innerHTML = '';
            const q = document.getElementById('search-input').value.toLowerCase();
            const flt = list.filter(t => t.desc.toLowerCase().includes(q));
            
            let lastD = ''; let group = null;
            flt.forEach(t => {
                const dStr = new Date(t.date).toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'short'});
                if(dStr !== lastD) {
                    if(group) el.appendChild(group);
                    const head = document.createElement('div'); head.className = 'date-header'; head.innerText = dStr;
                    el.appendChild(head);
                    group = document.createElement('div'); group.className = 't-group'; lastD = dStr;
                }
                const c = CATS.find(x=>x.id===t.cat) || CATS[0];
                const color = t.amt > 0 ? 'var(--inc)' : (t.cat==='invest' ? 'var(--inv)' : '#fff');
                const tag = t.isProj ? '<span class="tag proj">PROY</span>' : (t.rec ? '<span class="tag rec">FIJO</span>' : '');
                group.innerHTML += `<div class="t-item" onclick="editTr('${t.id}')">
                    <div class="t-left"><div class="t-icon">${c.i}</div><div><div class="t-desc">${t.desc}</div><div class="t-meta">${tag}</div></div></div>
                    <div class="t-amt" style="color:${color}">${t.amt>0?'+':''}${t.amt.toFixed(2)}‚Ç¨</div>
                </div>`;
            });
            if(group) el.appendChild(group);
        }

        // --- ANALYTICS ---
        function setAnalSegment(s) { analSegment = s; document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active')); document.getElementById('seg-'+s).classList.add('active'); runAnalytics(); }
        function runAnalytics() {
            const now = new Date(); let s, e;
            if(analSegment==='day'){ s=new Date(); e=new Date(); }
            else if(analSegment==='week'){ s=new Date(); s.setDate(now.getDate()-7); e=new Date(); }
            else if(analSegment==='month'){ s=new Date(now.getFullYear(), now.getMonth(), 1); e=new Date(now.getFullYear(), now.getMonth()+1,0); }
            else { s=new Date(now.getFullYear(), 0, 1); e=new Date(now.getFullYear(), 11, 31); }

            const data = getDataInRange(s, e);
            const inc = data.filter(t=>t.amt>0).reduce((a,b)=>a+b.amt,0);
            const exp = data.filter(t=>t.amt<0 && t.cat!=='invest').reduce((a,b)=>a+Math.abs(t.amt),0);
            const inv = data.filter(t=>t.cat==='invest').reduce((a,b)=>a+Math.abs(t.amt),0);

            document.getElementById('kpi-rate').innerText = inc > 0 ? ((inc-exp)/inc*100).toFixed(0)+'%' : '0%';
            document.getElementById('kpi-flow').innerText = fmt(inc - exp - inv);
            document.getElementById('kpi-avg').innerText = fmt(exp / (data.filter(t=>t.amt<0).length || 1));

            // Flow Chart
            const flow = {}; data.forEach(t => { const k = new Date(t.date).toLocaleDateString('es', {day:'numeric', month:'short'}); flow[k] = (flow[k]||0) + t.amt; });
            if(charts.c1) charts.c1.destroy();
            charts.c1 = new Chart(document.getElementById('flowChart'), { type:'bar', data: { labels: Object.keys(flow), datasets: [{label:'Neto', data:Object.values(flow), backgroundColor:'#38BDF8'}] }, options:{maintainAspectRatio:false, plugins:{legend:{display:false}}} });

            // Cat Chart
            const cats = {}; data.filter(t=>t.amt<0).forEach(t => { cats[t.cat] = (cats[t.cat]||0) + Math.abs(t.amt); });
            if(charts.c2) charts.c2.destroy();
            charts.c2 = new Chart(document.getElementById('catChart'), { type:'doughnut', data: { labels: Object.keys(cats).map(k=>CATS.find(x=>x.id===k).n), datasets: [{data:Object.values(cats), backgroundColor:['#F87171','#A78BFA','#FBBF24','#34D399']}] }, options:{maintainAspectRatio:false} });
        }

        // --- FORM & HELPERS ---
        function renderCats() { const g = document.getElementById('cat-grid'); g.innerHTML = ''; CATS.forEach(c => { g.innerHTML += `<div class="cat-item ${c.id===selectedCat?'selected':''}" onclick="selectedCat='${c.id}';renderCats()"><span class="cat-icon">${c.i}</span><span class="cat-name">${c.n}</span></div>`; }); }
        function openForm() { document.getElementById('form-modal').classList.add('open'); editingId=null; document.getElementById('btn-delete-tr').style.display='none'; }
        function closeModal() { document.getElementById('form-modal').classList.remove('open'); }
        function setType(t) { currentType = t; document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active-exp','active-inc','active-inv')); document.getElementById('btn-type-'+t.slice(0,3)).classList.add('active-'+t.slice(0,3)); if(t==='investment')selectedCat='invest'; renderCats(); }
        function saveTransaction() {
            const desc = document.getElementById('inp-desc').value;
            const amt = parseFloat(document.getElementById('inp-amt').value);
            const date = document.getElementById('inp-date').value;
            const rec = document.getElementById('inp-rec').checked;
            if(!desc || !amt) return;
            const val = currentType === 'income' ? Math.abs(amt) : -Math.abs(amt);
            if(editingId) {
                const cleanId = String(editingId).split('_')[0];
                const i = db.findIndex(x=>String(x.id)===cleanId);
                db[i] = {id:db[i].id, desc, amt:val, date, cat:selectedCat, rec};
            } else { db.push({id:Date.now(), desc, amt:val, date, cat:selectedCat, rec}); }
            closeModal(); updateUI();
        }
        function editTr(id) {
            const cleanId = String(id).split('_')[0];
            const t = db.find(x=>String(x.id)===cleanId); if(!t) return;
            editingId = id;
            document.getElementById('inp-desc').value = t.desc;
            document.getElementById('inp-amt').value = Math.abs(t.amt);
            document.getElementById('inp-date').value = t.date;
            document.getElementById('inp-rec').checked = t.rec;
            setType(t.amt>0 ? 'income' : (t.cat==='invest' ? 'investment' : 'expense'));
            selectedCat = t.cat; renderCats();
            document.getElementById('btn-delete-tr').style.display='block';
            document.getElementById('form-modal').classList.add('open');
        }
        function deleteTr() { const cleanId = String(editingId).split('_')[0]; db = db.filter(x=>String(x.id)!==cleanId); closeModal(); updateUI(); }
        function exportData() { const blob = new Blob([JSON.stringify(db)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click(); }
        function importData(e) { const reader = new FileReader(); reader.onload = () => { db = JSON.parse(reader.result); updateUI(); }; reader.readAsText(e.files[0]); }
        const fmt = (n) => n.toLocaleString('es-ES', {style:'currency', currency:'EUR', maximumFractionDigits:0});
    </script>
</body>
</html>
